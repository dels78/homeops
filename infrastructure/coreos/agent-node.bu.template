variant: fcos
version: 1.5.0

# Fedora CoreOS Butane config for k3s agent nodes
# Template variables (replaced at build time):
#   {{HOSTNAME}}  - Node hostname
#   {{K3S_TOKEN}} - Cluster join token (secret - never commit!)
#   {{K3S_SERVER}} - K3s server URL (e.g., https://<master-ip>:6443)
#   {{SSH_PUBKEY}} - SSH public key for core user

passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - {{SSH_PUBKEY}}

storage:
  files:
    # Hostname
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: {{HOSTNAME}}

    # K3s installer script (runs once on first boot)
    - path: /usr/local/bin/run-k3s-installer
      mode: 0755
      contents:
        inline: |
          #!/usr/bin/env sh
          main() {
            export K3S_KUBECONFIG_MODE="644"
            curl -sfL https://get.k3s.io | K3S_TOKEN={{K3S_TOKEN}} sh -s - agent --server {{K3S_SERVER}}
            return 0
          }
          main

    # Gate file for k3s installer service
    - path: /var/lib/k3s-prereq-installed
      mode: 0644
      contents:
        inline: ""

systemd:
  units:
    # One-shot service to install k3s on first boot
    - name: run-k3s-installer.service
      enabled: true
      contents: |
        [Unit]
        After=network-online.target
        Wants=network-online.target
        Before=systemd-user-sessions.service
        OnFailure=emergency.target
        OnFailureJobMode=replace-irreversibly
        ConditionPathExists=/var/lib/k3s-prereq-installed
        ConditionPathExists=!/var/lib/k3s-installed
        [Service]
        RemainAfterExit=yes
        Type=oneshot
        ExecStart=/usr/local/bin/run-k3s-installer
        ExecStartPost=/usr/bin/touch /var/lib/k3s-installed
        StandardOutput=kmsg+console
        StandardError=kmsg+console
        [Install]
        WantedBy=multi-user.target

    # Autologin on console for easier debugging
    - name: getty@tty1.service
      dropins:
        - name: autologin-core.conf
          contents: |
            [Service]
            ExecStart=
            ExecStart=-/usr/sbin/agetty --autologin core --noclear %I $TERM

    # Install k3s-selinux package after first boot
    - name: rpm-ostree-install-k3s-selinux.service
      enabled: true
      contents: |
        [Unit]
        Description=Layer k3s-selinux with rpm-ostree
        Wants=network-online.target
        After=network-online.target
        Before=run-k3s-installer.service
        ConditionPathExists=!/var/lib/%N.stamp
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/rpm-ostree install --apply-live --allow-inactive k3s-selinux
        ExecStart=/bin/touch /var/lib/%N.stamp
        [Install]
        WantedBy=multi-user.target
