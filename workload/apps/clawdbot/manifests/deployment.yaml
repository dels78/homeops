---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: clawdbot
  namespace: automation
  labels:
    app.kubernetes.io/name: clawdbot
    app.kubernetes.io/instance: clawdbot
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: clawdbot
      app.kubernetes.io/instance: clawdbot
  template:
    metadata:
      labels:
        app.kubernetes.io/name: clawdbot
        app.kubernetes.io/instance: clawdbot
    spec:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsNonRoot: true
      imagePullSecrets:
        - name: ghcr-pull-secret
      initContainers:
        - name: bootstrap-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              # Only copy bootstrap config if clawdbot.json doesn't exist
              if [ ! -f /home/node/.clawdbot/clawdbot.json ]; then
                echo "Bootstrapping clawdbot.json from ConfigMap..."
                mkdir -p /home/node/.clawdbot
                cp /bootstrap/clawdbot.json /home/node/.clawdbot/clawdbot.json
                echo "Bootstrap complete"
              else
                echo "Config already exists, skipping bootstrap"
              fi
          volumeMounts:
            - name: data
              mountPath: /home/node
            - name: bootstrap-config
              mountPath: /bootstrap
      containers:
        - name: clawdbot
          # Build from https://github.com/clawdbot/clawdbot
          # No official pre-built images available yet; must build yourself
          # See workload/apps/README-automation.md for build instructions
          image: ghcr.io/dels78/clawdbot:latest
          imagePullPolicy: Always
          command: ["node", "dist/index.js", "gateway-daemon", "--bind", "lan", "--port", "18789"]
          env:
            # Home directory (required for ClawdBot to find config)
            - name: HOME
              value: "/home/node"
            # ClawdBot authentication (Claude AI session)
            - name: CLAUDE_AI_SESSION_KEY
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: claude-session-key
            # Gateway configuration
            - name: CLAWDBOT_GATEWAY_PORT
              value: "18789"
            - name: CLAWDBOT_BRIDGE_PORT
              value: "18790"
            - name: CLAWDBOT_GATEWAY_BIND
              value: "lan"
            - name: CLAWDBOT_GATEWAY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: gateway-token
            # Slack integration
            - name: SLACK_APP_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: slack-app-token
            - name: SLACK_BOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: slack-bot-token
            # GitHub App authentication
            - name: GITHUB_APP_ID
              value: "2677285"
            - name: GITHUB_APP_INSTALLATION_ID
              value: "104738677"
            - name: GITHUB_APP_PRIVATE_KEY_PATH
              value: "/secrets/github-app-private-key.pem"
            # Terminal settings
            - name: TERM
              value: "xterm-256color"
          ports:
            - name: gateway
              containerPort: 18789
              protocol: TCP
            - name: bridge
              containerPort: 18790
              protocol: TCP
          volumeMounts:
            - name: data
              mountPath: /home/node
            - name: github-app-key
              mountPath: /secrets
              readOnly: true
          resources:
            requests:
              cpu: 200m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          # Note: ClawdBot may not expose standard health endpoints
          # Monitor via pod restarts and logs instead
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: clawdbot-data
        - name: bootstrap-config
          configMap:
            name: clawdbot-config
        - name: github-app-key
          secret:
            secretName: clawdbot-secrets
            items:
              - key: github-app-private-key.pem
                path: github-app-private-key.pem
      restartPolicy: Always
