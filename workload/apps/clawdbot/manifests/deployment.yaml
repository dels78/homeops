---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: clawdbot
  namespace: automation
  labels:
    app.kubernetes.io/name: clawdbot
    app.kubernetes.io/instance: clawdbot
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app.kubernetes.io/name: clawdbot
      app.kubernetes.io/instance: clawdbot
  template:
    metadata:
      labels:
        app.kubernetes.io/name: clawdbot
        app.kubernetes.io/instance: clawdbot
    spec:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsNonRoot: true
      initContainers:
        - name: bootstrap-config
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              # Create required OpenClaw directory structure
              mkdir -p /home/node/.openclaw/agents/main/sessions
              mkdir -p /home/node/.openclaw/credentials
              chmod 700 /home/node/.openclaw
              # Replace config if stale (missing trustedProxies or has old CLAWDBOT_ refs)
              if [ -f /home/node/.openclaw/openclaw.json ]; then
                if grep -q "CLAWDBOT_" /home/node/.openclaw/openclaw.json || ! grep -q "trustedProxies" /home/node/.openclaw/openclaw.json; then
                  echo "Replacing outdated config from ConfigMap..."
                  cp /bootstrap/openclaw.json /home/node/.openclaw/openclaw.json
                  echo "Config replaced"
                else
                  echo "Config already exists, skipping bootstrap"
                fi
              else
                echo "Bootstrapping openclaw.json from ConfigMap..."
                cp /bootstrap/openclaw.json /home/node/.openclaw/openclaw.json
                echo "Bootstrap complete"
              fi
          volumeMounts:
            - name: data
              mountPath: /home/node
            - name: bootstrap-config
              mountPath: /bootstrap
      containers:
        - name: openclaw
          image: ghcr.io/openclaw/openclaw:latest
          imagePullPolicy: Always
          command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789"]
          env:
            # Home directory (required for OpenClaw to find config)
            - name: HOME
              value: "/home/node"
            # OpenClaw authentication (Claude AI session)
            - name: CLAUDE_AI_SESSION_KEY
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: claude-session-key
            # Gateway configuration
            - name: OPENCLAW_GATEWAY_PORT
              value: "18789"
            - name: OPENCLAW_BRIDGE_PORT
              value: "18790"
            - name: OPENCLAW_GATEWAY_BIND
              value: "lan"
            - name: OPENCLAW_GATEWAY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: gateway-token
            # Slack integration
            - name: SLACK_APP_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: slack-app-token
            - name: SLACK_BOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: clawdbot-secrets
                  key: slack-bot-token
            # GitHub App authentication
            - name: GITHUB_APP_ID
              value: "2679439"
            - name: GITHUB_APP_INSTALLATION_ID
              value: "104792861"
            - name: GITHUB_APP_PRIVATE_KEY_PATH
              value: "/secrets/github-app-private-key.pem"
            # Terminal settings
            - name: TERM
              value: "xterm-256color"
          ports:
            - name: gateway
              containerPort: 18789
              protocol: TCP
            - name: bridge
              containerPort: 18790
              protocol: TCP
          volumeMounts:
            - name: data
              mountPath: /home/node
            - name: github-app-key
              mountPath: /secrets
              readOnly: true
          resources:
            requests:
              cpu: 200m
              memory: 1Gi
            limits:
              cpu: 1000m
              memory: 2Gi
          # Note: OpenClaw may not expose standard health endpoints
          # Monitor via pod restarts and logs instead
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: clawdbot-data
        - name: bootstrap-config
          configMap:
            name: clawdbot-config
        - name: github-app-key
          secret:
            secretName: clawdbot-secrets
            items:
              - key: github-app-private-key.pem
                path: github-app-private-key.pem
      restartPolicy: Always
