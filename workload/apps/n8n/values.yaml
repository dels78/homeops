---
# n8n Helm chart values
# Using official n8n Helm chart: https://github.com/8gears/n8n-helm-chart

replicaCount: 1

image:
  repository: n8nio/n8n
  pullPolicy: IfNotPresent
  # NOTE: image tag is managed by kustomization.yaml `images:` section
  # Do not set tag here - it will be overridden by kustomize

service:
  type: ClusterIP
  port: 5678

main:
  # Configuration converted to environment variables
  # See https://docs.n8n.io/hosting/configuration/environment-variables/
  config:
    # Database configuration
    db:
      type: "postgresdb"
      postgresdb:
        host: "postgresql.automation.svc.cluster.local"
        port: 5432
        database: "n8n"
        user: "n8n"

    # General n8n configuration
    n8n:
      host: "n8n.delisle.me"
      protocol: "https"
      editor_base_url: "https://n8n.delisle.me/"

    generic:
      timezone: "America/New_York"

    webhook:
      url: "https://n8n.delisle.me/"

    executions:
      process: "main"
      mode: "regular"

  # Extra env vars that reference secrets
  extraEnv:
    DB_POSTGRESDB_PASSWORD:
      valueFrom:
        secretKeyRef:
          name: n8n-secrets
          key: db-password
    N8N_ENCRYPTION_KEY:
      valueFrom:
        secretKeyRef:
          name: n8n-secrets
          key: encryption-key
    TZ:
      value: "America/New_York"

  persistence:
    enabled: true
    type: existing
    existingClaim: n8n

  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 2Gi

  livenessProbe:
    enabled: true
    httpGet:
      path: /healthz
      port: 5678
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 5

  readinessProbe:
    enabled: true
    httpGet:
      path: /healthz
      port: 5678
    initialDelaySeconds: 30
    periodSeconds: 15
    timeoutSeconds: 5
    failureThreshold: 3

# Disable ingress in Helm chart (we manage it separately)
ingress:
  enabled: false

# Security context
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Use our ServiceAccount with RBAC for agent jobs
serviceAccount:
  create: false
  name: n8n
