---
# CronJob to refresh GHCR pull secret using GitHub App credentials
# Runs hourly to keep the imagePullSecret valid (tokens expire after 1 hour)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ghcr-token-refresh
  namespace: temporal
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: ghcr-refresh
spec:
  schedule: "0 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ghcr-token-refresh
          restartPolicy: OnFailure
          containers:
            - name: refresh
              image: bitnami/kubectl:latest
              env:
                - name: GITHUB_APP_ID
                  valueFrom:
                    secretKeyRef:
                      name: github-app
                      key: github-app-id
                - name: GITHUB_APP_INSTALLATION_ID
                  valueFrom:
                    secretKeyRef:
                      name: github-app
                      key: github-installation-id
                - name: GITHUB_APP_PRIVATE_KEY
                  valueFrom:
                    secretKeyRef:
                      name: github-app
                      key: github-app-private-key
                - name: NAMESPACE
                  value: temporal
                - name: SECRET_NAME
                  value: ghcr-pull-secret
              command:
                - /bin/bash
                - -c
                - |
                  set -e

                  # Generate JWT header and payload
                  NOW=$(date +%s)
                  IAT=$((NOW - 60))
                  EXP=$((NOW + 600))

                  b64enc() { openssl base64 -e | tr -d '=' | tr '/+' '_-' | tr -d '\n'; }

                  HEADER=$(echo -n '{"alg":"RS256","typ":"JWT"}' | b64enc)
                  PAYLOAD=$(echo -n "{\"iat\":${IAT},\"exp\":${EXP},\"iss\":\"${GITHUB_APP_ID}\"}" | b64enc)

                  # Write private key to temp file (handles single-line format from secret)
                  KEY_FILE=$(mktemp)
                  echo "$GITHUB_APP_PRIVATE_KEY" > "$KEY_FILE"
                  trap "rm -f $KEY_FILE" EXIT

                  # Sign JWT
                  SIGNATURE=$(echo -n "${HEADER}.${PAYLOAD}" | openssl dgst -sha256 -sign "$KEY_FILE" | b64enc)
                  JWT="${HEADER}.${PAYLOAD}.${SIGNATURE}"

                  # Get installation token
                  TOKEN=$(curl -sf -X POST \
                    -H "Authorization: Bearer ${JWT}" \
                    -H "Accept: application/vnd.github+json" \
                    "https://api.github.com/app/installations/${GITHUB_APP_INSTALLATION_ID}/access_tokens" | jq -r '.token')

                  if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
                    echo "ERROR: Failed to get installation token"
                    exit 1
                  fi

                  # Create or update the pull secret
                  kubectl create secret docker-registry "$SECRET_NAME" \
                    --namespace="$NAMESPACE" \
                    --docker-server=ghcr.io \
                    --docker-username=x-access-token \
                    --docker-password="$TOKEN" \
                    --dry-run=client -o yaml | kubectl apply -f -

                  echo "Successfully refreshed $SECRET_NAME in $NAMESPACE"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ghcr-token-refresh
  namespace: temporal
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: ghcr-refresh
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ghcr-token-refresh
  namespace: temporal
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: ghcr-refresh
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ghcr-token-refresh
  namespace: temporal
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: ghcr-refresh
subjects:
  - kind: ServiceAccount
    name: ghcr-token-refresh
    namespace: temporal
roleRef:
  kind: Role
  name: ghcr-token-refresh
  apiGroup: rbac.authorization.k8s.io
