---
# CronJob to refresh GHCR pull secret using GitHub App credentials
# Runs hourly to keep the imagePullSecret valid (tokens expire after 1 hour)
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ghcr-token-refresh
  namespace: temporal
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: ghcr-refresh
spec:
  schedule: "0 * * * *"  # Every hour
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: ghcr-token-refresh
          restartPolicy: OnFailure
          containers:
            - name: refresh
              image: ghcr.io/tarampampam/curl:latest
              env:
                - name: GITHUB_APP_ID
                  valueFrom:
                    secretKeyRef:
                      name: github-app
                      key: github-app-id
                - name: GITHUB_APP_INSTALLATION_ID
                  valueFrom:
                    secretKeyRef:
                      name: github-app
                      key: github-installation-id
                - name: GITHUB_APP_PRIVATE_KEY
                  valueFrom:
                    secretKeyRef:
                      name: github-app
                      key: github-app-private-key
                - name: NAMESPACE
                  value: "temporal"
                - name: SECRET_NAME
                  value: "ghcr-pull-secret"
              command: ["/bin/sh", "-c"]
              args:
                - |
                  set -e
                  apk add --no-cache openssl jq kubectl > /dev/null 2>&1
                  
                  # Generate JWT
                  NOW=$(date +%s)
                  IAT=$((NOW - 60))
                  EXP=$((NOW + 600))
                  
                  HEADER=$(printf '{"alg":"RS256","typ":"JWT"}' | openssl base64 -e | tr -d '=' | tr '/+' '_-' | tr -d '
')
                  PAYLOAD=$(printf '{"iat":%d,"exp":%d,"iss":"%s"}' "$IAT" "$EXP" "$GITHUB_APP_ID" | openssl base64 -e | tr -d '=' | tr '/+' '_-' | tr -d '
')
                  
                  # Sign JWT
                  SIGNATURE=$(printf '%s.%s' "$HEADER" "$PAYLOAD" | openssl dgst -sha256 -sign <(echo "$GITHUB_APP_PRIVATE_KEY") | openssl base64 -e | tr -d '=' | tr '/+' '_-' | tr -d '
')
                  JWT="${HEADER}.${PAYLOAD}.${SIGNATURE}"
                  
                  # Get installation token
                  TOKEN=$(curl -s -X POST \
                    -H "Authorization: Bearer ${JWT}" \
                    -H "Accept: application/vnd.github+json" \
                    "https://api.github.com/app/installations/${GITHUB_APP_INSTALLATION_ID}/access_tokens" | jq -r '.token')
                  
                  if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
                    echo "Failed to get installation token"
                    exit 1
                  fi
                  
                  # Create dockerconfigjson
                  AUTH=$(printf "x-access-token:%s" "$TOKEN" | base64 | tr -d '
')
                  DOCKERCONFIG=$(printf '{"auths":{"ghcr.io":{"auth":"%s"}}}' "$AUTH")
                  
                  # Update or create the secret
                  kubectl create secret docker-registry "$SECRET_NAME" \
                    --namespace="$NAMESPACE" \
                    --docker-server=ghcr.io \
                    --docker-username=x-access-token \
                    --docker-password="$TOKEN" \
                    --dry-run=client -o yaml | kubectl apply -f -
                  
                  echo "Successfully refreshed $SECRET_NAME in $NAMESPACE"
---
# ServiceAccount for the CronJob
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ghcr-token-refresh
  namespace: temporal
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: ghcr-refresh
---
# Role to manage the pull secret
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ghcr-token-refresh
  namespace: temporal
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: ghcr-refresh
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
    resourceNames: ["ghcr-pull-secret"]
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create"]
---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ghcr-token-refresh
  namespace: temporal
  labels:
    app.kubernetes.io/name: temporal
    app.kubernetes.io/component: ghcr-refresh
subjects:
  - kind: ServiceAccount
    name: ghcr-token-refresh
    namespace: temporal
roleRef:
  kind: Role
  name: ghcr-token-refresh
  apiGroup: rbac.authorization.k8s.io
