---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-init
  namespace: automation
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/instance: postgresql
data:
  init-databases.sh: |
    #!/bin/bash
    set -e

    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
        -- Create n8n database and user
        CREATE DATABASE n8n;
        CREATE USER n8n WITH ENCRYPTED PASSWORD '$N8N_DB_PASSWORD';
        GRANT ALL PRIVILEGES ON DATABASE n8n TO n8n;

        -- Create orchestration database for agent dev loop state
        -- Uses existing temporal user (connected via github-app secret)
        CREATE DATABASE orchestration;
        GRANT ALL PRIVILEGES ON DATABASE orchestration TO temporal;
    EOSQL

    # Grant schema-level permissions (Postgres 15+ revoked public CREATE by default)
    # and pre-create the orchestration_writer role (temporal user lacks CREATEROLE)
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "orchestration" <<-EOSQL
        GRANT ALL ON SCHEMA public TO temporal;
        CREATE ROLE orchestration_writer NOLOGIN;
        GRANT orchestration_writer TO temporal;
    EOSQL

    echo "Databases created successfully"
